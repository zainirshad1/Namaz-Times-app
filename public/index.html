<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Namaz Times</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
        }
        .current-prayer-card {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(26, 111, 76, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(26, 111, 76, 0); }
            100% { box-shadow: 0 0 0 0 rgba(26, 111, 76, 0); }
        }
        .highlight-farz {
            color: #2f855a; /* Darker green for Farz */
            font-weight: bold;
        }
        .highlight-sunnah {
            color: #68d391; /* Lighter green for Sunnah Muakkadah */
            font-weight: bold;
        }
        .prayer-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem; /* Increased rounding */
            background-color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .prayer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .rakat-list {
            margin-left: 20px;
            flex-shrink: 0;
            text-align: center;
        }
        .rakat-container {
            flex-grow: 1;
            display: flex;
            justify-content: flex-end; /* Align to the right */
            align-items: center;
        }
        /* Custom message box styles */
        #custom-message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #custom-message-box.show {
            display: block;
            opacity: 1;
        }
        #custom-message-box.error {
            background-color: #f44336;
        }
        #custom-message-box.info {
            background-color: #2196F3;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease-in-out;
        }
        .modal-overlay.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
        }
        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a202c;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4a5568;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #2d3748;
        }
        .modal-body p {
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        .modal-body strong {
            color: #2d3748;
        }
        /* Dropdown menu styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-content a, .dropdown-content button {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: 'Poppins', sans-serif;
        }
        .dropdown-content a:hover, .dropdown-content button:hover {
            background-color: #f1f1f1;
        }
        .rakat-type-farz {
            color: #2f855a;
        }
        .rakat-type-sunnah {
            color: #68d391;
        }
        .rakat-type-witr {
            color: #4c51bf;
        }
        .rakat-type-nafil {
            color: #718096;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gradient-to-b from-green-50 to-white">

    <div class="bg-gradient-to-r from-green-600 to-green-800 text-white py-6 px-6 flex flex-col sm:flex-row justify-between items-center rounded-b-3xl shadow-lg">
        <div class="flex-grow">
            <h1 class="text-3xl font-bold mb-1">Namaz Times</h1>
            <p id="current-time-header" class="text-green-100 text-lg">Loading time...</p>
            <p class="text-green-100 text-sm"><span id="current-day">Loading day...</span>, <span id="current-date">Loading date...</span></p>
            <p id="hijri-date" class="text-green-100 text-sm">Loading Hijri date...</p>
        </div>
        <div id="user-auth-section" class="flex items-center space-x-4 mt-4 sm:mt-0">
            <!-- Quran button and Login/User Profile will be dynamically added here -->
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 flex-1">
        <div class="bg-gradient-to-br from-green-50 to-white rounded-2xl shadow-2xl p-6 mb-8 transform transition-transform duration-300 hover:scale-105">
            <div class="flex items-center space-x-4 mb-4 border-b pb-4">
                <i class="fas fa-search text-green-700 text-2xl"></i>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Masjid & Location</h2>
                    <p id="masjid-location-info" class="text-green-700 text-sm font-medium mt-1"></p>
                </div>
            </div>
            
            <div class="mb-4">
                <select id="masjid-select" class="bg-green-100 text-green-800 font-medium py-3 px-4 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                    <option value="">Choose nearby masjid</option>
                </select>
                <div class="flex flex-wrap gap-2 mt-2">
                    <button id="location-btn" class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-2 px-4 rounded-lg transition" aria-label="Get My Location">
                        <i class="fas fa-map-marker-alt mr-2"></i>My Location
                    </button>
                    <button id="view-details-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg transition hidden">
                        <i class="fas fa-info-circle mr-2"></i>Details
                    </button>
                    <button id="directions-btn" class="bg-green-100 hover:bg-green-200 text-green-800 font-medium py-2 px-4 rounded-lg transition hidden">
                        <i class="fas fa-directions mr-2"></i>Directions
                    </button>
                </div>
                <p id="user-current-location" class="text-gray-500 text-sm mt-3"></p>
            </div>

            <div class="text-center bg-green-50 rounded-xl p-4 shadow-inner">
                <p class="text-4xl font-bold text-green-700 mb-2" id="current-time-main"></p>
                <div class="flex flex-col md:flex-row justify-center md:space-x-8 text-gray-600">
                    <div class="mb-2 md:mb-0">
                        <p class="text-lg">Next Prayer: <span id="next-prayer-name" class="font-bold text-green-600">None</span></p>
                        <p class="text-xl font-bold text-green-700">at <span id="next-prayer-time" class="font-medium">--:-- --</span></p>
                    </div>
                    <div class="flex items-center">
                        <p class="text-lg">Duration Left: <span id="duration-left" class="font-bold text-green-600">--:--</span></p>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center space-x-4 mt-4 text-gray-600 text-sm">
                    <p class="mt-1 flex items-center"><i class="fas fa-moon mr-2 text-blue-500"></i>Sehri End: <span id="sehri-time" class="font-medium text-green-600 ml-1">--:-- --</span></p>
                    <p class="mt-1 flex items-center"><i class="fas fa-sun mr-2 text-yellow-500"></i>Iftari: <span id="iftari-time" class="font-medium text-green-600 ml-1">--:-- --</span></p>
                </div>
            </div>
        </div>

        <div id="prayer-times" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <footer class="bg-green-800 text-white py-4 mt-auto">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>© 2023 Namaz Times App</p>
            <p class="text-green-200 mt-1">Prayer times calculated for your selected masjid</p>
        </div>
    </footer>

    <div id="custom-message-box" class="hidden"></div>
    <div id="masjid-details-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Masjid Details</h3>
                <button id="modal-close-btn" class="modal-close-btn">×</button>
            </div>
            <div id="masjid-details-modal-body" class="modal-body"></div>
        </div>
    </div>
    <div id="profile-details-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Profile</h3>
                <button id="profile-modal-close-btn" class="modal-close-btn">×</button>
            </div>
            <div id="profile-details-modal-body" class="modal-body"></div>
        </div>
    </div>
    <div id="change-password-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button id="change-password-modal-close-btn" class="modal-close-btn">×</button>
            </div>
            <div id="change-password-modal-body" class="modal-body">
                <p class="mb-2">Enter your new password.</p>
                <input type="password" id="new-password" placeholder="New Password" class="w-full p-2 border border-gray-300 rounded mb-2">
                <input type="password" id="confirm-password" placeholder="Confirm Password" class="w-full p-2 border border-gray-300 rounded mb-4">
                <button id="update-password-btn" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Update Password</button>
            </div>
        </div>
    </div>
    <div id="qibla-direction-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Qibla Direction</h3>
                <button id="qibla-direction-modal-close-btn" class="modal-close-btn">×</button>
            </div>
            <div id="qibla-direction-modal-body" class="modal-body text-center">
                <p id="qibla-status" class="text-gray-500">Getting your location...</p>
                <div id="qibla-indicator-container" class="mt-4"></div>
            </div>
        </div>
    </div>
    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button id="settings-modal-close-btn" class="modal-close-btn">×</button>
            </div>
            <div id="settings-modal-body" class="modal-body">
                <h4 class="font-semibold mb-2">Asr Calculation Method:</h4>
                <div class="flex items-center mb-4">
                    <input type="radio" id="asr-hanafi" name="asr-school" value="1" class="mr-2">
                    <label for="asr-hanafi">Hanafi</label>
                </div>
                <div class="flex items-center mb-4">
                    <input type="radio" id="asr-shafi" name="asr-school" value="0" class="mr-2">
                    <label for="asr-shafi">Shafi</label>
                </div>
                <button id="save-settings-btn" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Save Settings</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAhPYAh6wrTzlIdDPmomsFWDOquKlyG6Pk",
            authDomain: "namaz-times-app.firebaseapp.com",
            projectId: "namaz-times-app",
            storageBucket: "namaz-times-app.firebasestorage.app",
            messagingSenderId: "974582220585",
            appId: "1:974582220585:web:092a933942836566f95938",
            measurementId: "G-3CTLSN6BLS"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Default prayer times (fallback)
        const defaultPrayerTimes = {
            Fajr: { name: "Fajr", prayerTime: "05:30", azanTime: "05:00", endTime: "06:30" },
            Dhuhr: { name: "Dhuhr", prayerTime: "12:30", azanTime: "12:00", endTime: "14:30" },
            Asr: { name: "Asr", prayerTime: "15:45", azanTime: "15:15", endTime: "17:45" },
            Maghrib: { name: "Maghrib", prayerTime: "18:30", azanTime: "18:20", endTime: "19:30" },
            Isha: { name: "Isha", prayerTime: "19:45", azanTime: "19:30", endTime: "21:45" },
            Jumuah: { name: "Jumuah", prayerTime: "13:15", azanTime: "13:00", endTime: "14:15" }
        };

        // DOM Elements
        const userAuthSection = document.getElementById('user-auth-section');
        const customMessageBox = document.getElementById('custom-message-box');
        const viewDetailsBtn = document.getElementById('view-details-btn');
        const directionsBtn = document.getElementById('directions-btn');
        const masjidDetailsModalOverlay = document.getElementById('masjid-details-modal-overlay');
        const masjidDetailsModalBody = document.getElementById('masjid-details-modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const currentEnglishTimeHeader = document.getElementById('current-time-header');
        const currentEnglishDayDisplay = document.getElementById('current-day');
        const currentEnglishDateDisplay = document.getElementById('current-date');
        const masjidLocationInfo = document.getElementById('masjid-location-info');
        const userCurrentLocationDisplay = document.getElementById('user-current-location');
        const profileDetailsModalOverlay = document.getElementById('profile-details-modal-overlay');
        const profileDetailsModalBody = document.getElementById('profile-details-modal-body');
        const profileModalCloseBtn = document.getElementById('profile-modal-close-btn');
        const locationBtn = document.getElementById('location-btn');
        const currentTimeMain = document.getElementById('current-time-main');
        // Removed quranBtn from global scope as it's now created dynamically

        // New modal DOM elements
        const changePasswordModalOverlay = document.getElementById('change-password-modal-overlay');
        const changePasswordModalCloseBtn = document.getElementById('change-password-modal-close-btn');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const updatePasswordBtn = document.getElementById('update-password-btn');
        const qiblaDirectionModalOverlay = document.getElementById('qibla-direction-modal-overlay');
        const qiblaDirectionModalCloseBtn = document.getElementById('qibla-direction-modal-close-btn');
        const qiblaStatus = document.getElementById('qibla-status');
        const qiblaIndicatorContainer = document.getElementById('qibla-indicator-container');
        const settingsModalOverlay = document.getElementById('settings-modal-overlay');
        const settingsModalCloseBtn = document.getElementById('settings-modal-close-btn');
        const asrHanafiRadio = document.getElementById('asr-hanafi');
        const asrShafiRadio = document.getElementById('asr-shafi');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const sehriTimeDisplay = document.getElementById('sehri-time');
        const iftariTimeDisplay = document.getElementById('iftari-time');

        let currentMasjidDetails = null;
        let currentUserPrayerTimes = [];
        let currentUserRole = null;
        let userProfileData = null;
        let userLocation = { latitude: null, longitude: null, city: null, country: null };
        let asrCalculationSchool = '1';

        // --- Custom Message Box Function ---
        function showCustomMessage(message, type = 'success', duration = 3000) {
            customMessageBox.textContent = message;
            customMessageBox.classList.remove('success', 'error', 'info');
            customMessageBox.classList.add(type);
            customMessageBox.classList.add('show');
            setTimeout(() => {
                customMessageBox.classList.remove('show');
            }, duration);
        }

        // Function to format time to AM/PM
        function formatTimeToAMPM(timeStr) {
            if (!timeStr || timeStr === 'N/A') return 'N/A';
            const [hours, minutes] = timeStr.split(':').map(Number);
            if (isNaN(hours) || isNaN(minutes)) {
                console.warn(`Invalid time string passed to formatTimeToAMPM: "${timeStr}"`);
                return 'N/A';
            }
            const date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes);
            date.setSeconds(0);
            const options = { hour: 'numeric', minute: 'numeric', hour12: true };
            return date.toLocaleTimeString([], options);
        }

        // Function to fetch all masjids from Firestore
        async function fetchAllMasjidsFromFirestore() {
            try {
                const masjidsCol = collection(db, 'masjids');
                const masjidSnapshot = await getDocs(masjidsCol);
                const masjids = masjidSnapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name,
                    ...doc.data()
                }));
                return masjids;
            } catch (error) {
                console.error('Error fetching masjids from Firestore:', error);
                showCustomMessage('Failed to load masjids. Please try again.', 'error');
                return [];
            }
        }

        // Function to populate masjid dropdown
        async function populateMasjidDropdown() {
            const masjidSelect = document.getElementById('masjid-select');
            masjidSelect.innerHTML = '<option value="">Choose nearby masjid</option>';
            const masjids = await fetchAllMasjidsFromFirestore();
            if (masjids.length > 0) {
                masjids.forEach(masjid => {
                    const option = document.createElement('option');
                    option.value = masjid.id;
                    option.textContent = masjid.name;
                    masjidSelect.appendChild(option);
                });
            } else {
                masjidSelect.innerHTML = '<option value="">No masjids found</option>';
            }
        }
        
        // Rakat lookup object
        const rakatFunctions = {
            Fajr: () => [{ type: 'sunnahMuakkadah', count: 2 }, { type: 'farz', count: 2 }],
            Dhuhr: () => [{ type: 'sunnahMuakkadah', count: 4 }, { type: 'farz', count: 4 }, { type: 'sunnahMuakkadah', count: 2 }, { type: 'nafil', count: 2 }],
            Asr: () => [{ type: 'sunnah', count: 4 }, { type: 'farz', count: 4 }],
            Maghrib: () => [{ type: 'farz', count: 3 }, { type: 'sunnahMuakkadah', count: 2 }, { type: 'nafil', count: 2 }],
            Isha: () => [{ type: 'sunnah', count: 4 }, { type: 'farz', count: 4 }, { type: 'sunnahMuakkadah', count: 2 }, { type: 'nafil', count: 2 }, { type: 'witr', count: 3 }, { type: 'nafil', count: 2 }],
            Jumuah: () => [{ type: 'sunnahMuakkadah', count: 4 }, { type: 'farz', count: 2 }, { type: 'sunnahMuakkadah', count: 4 }, { type: 'sunnahMuakkadah', count: 2 }, { type: 'nafil', count: 2 }]
        };

        // Function to format rakat details
        function formatRakatDetails(rakats) {
            const rakatDetails = [];
            rakats.forEach(rakat => {
                let type = rakat.type.charAt(0).toUpperCase() + rakat.type.slice(1);
                let typeClass = '';
                if (type.toLowerCase() === 'sunnahmuakkadah') {
                    type = 'Sunnah';
                    typeClass = 'rakat-type-sunnah';
                } else if (type.toLowerCase() === 'farz') {
                    typeClass = 'rakat-type-farz';
                } else if (type.toLowerCase() === 'witr') {
                    typeClass = 'rakat-type-witr';
                } else {
                    typeClass = 'rakat-type-nafil';
                }
                const count = rakat.count;
                rakatDetails.push(`<li class="${typeClass}">${type}: ${count}</li>`);
            });
            return `<ul class="list-disc list-inside text-sm font-medium">${rakatDetails.join('')}</ul>`;
        }

        // Helper function to create a Date object from a time string
        function createDateFromTime(timeStr, baseDate) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date(baseDate);
            date.setHours(hours);
            date.setMinutes(minutes);
            date.setSeconds(0);
            date.setMilliseconds(0);
            return date;
        }

        // Function to fetch prayer times from AlAdhan API
        async function fetchPrayerTimesFromAlAdhan(latitude, longitude, method = 1, school = 1) {
            if (!latitude || !longitude) {
                showCustomMessage('Location not available for AlAdhan API.', 'error');
                return null;
            }
            const today = new Date();
            const timestamp = Math.floor(today.getTime() / 1000);
            const apiUrl = `https://api.aladhan.com/v1/timings/${timestamp}?latitude=${latitude}&longitude=${longitude}&method=${method}&school=${school}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.status === 'OK' && data.data && data.data.timings) {
                    const timings = data.data.timings;
                    const fajrTime = timings.Fajr || '00:00';
                    const sunriseTime = timings.Sunrise || '00:00';
                    const dhuhrTime = timings.Dhuhr || '00:00';
                    const asrTime = timings.Asr || '00:00';
                    const maghribTime = timings.Maghrib || '00:00';
                    const ishaTime = timings.Isha || '00:00';
                    const fajrEndTime = sunriseTime;
                    const dhuhrEndTime = asrTime;
                    const asrEndTime = maghribTime;
                    const maghribEndTime = ishaTime;
                    const ishaEndTime = defaultPrayerTimes.Isha.endTime;

                    return {
                        Fajr: { azanTime: fajrTime, prayerTime: fajrTime, endTime: fajrEndTime },
                        Dhuhr: { azanTime: dhuhrTime, prayerTime: dhuhrTime, endTime: dhuhrEndTime },
                        Asr: { azanTime: asrTime, prayerTime: asrTime, endTime: asrEndTime },
                        Maghrib: { azanTime: maghribTime, prayerTime: maghribTime, endTime: maghribEndTime },
                        Isha: { azanTime: ishaTime, prayerTime: ishaTime, endTime: ishaEndTime },
                        Jumuah: { azanTime: defaultPrayerTimes.Jumuah.azanTime, prayerTime: defaultPrayerTimes.Jumuah.prayerTime, endTime: defaultPrayerTimes.Jumuah.endTime },
                        Sehri: fajrTime,
                        Iftari: maghribTime
                    };
                } else {
                    showCustomMessage('Failed to fetch prayer times from AlAdhan API.', 'error');
                    console.error('AlAdhan API response error:', data);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching from AlAdhan API:', error);
                showCustomMessage('Error fetching prayer times from external API. Using default.', 'error');
                return null;
            }
        }

        // Function to display prayer times
        async function displayPrayerTimes(masjidId) {
            const prayerTimesDiv = document.getElementById('prayer-times');
            prayerTimesDiv.innerHTML = '';
            currentMasjidDetails = null;
            masjidLocationInfo.textContent = '';
            currentUserPrayerTimes = [];
            sehriTimeDisplay.textContent = '--:-- --';
            iftariTimeDisplay.textContent = '--:-- --';
            viewDetailsBtn.classList.add('hidden');
            directionsBtn.classList.add('hidden');

            let prayerDetails = [];
            let currentSehriTime = 'N/A';
            let currentIftariTime = 'N/A';
            let locationForAPI = userLocation;
            let fetchedAlAdhanTimes = null;

            if (masjidId) {
                try {
                    const masjidDocRef = doc(db, 'masjids', masjidId);
                    const masjidDocSnap = await getDoc(masjidDocRef);

                    if (masjidDocSnap.exists()) {
                        currentMasjidDetails = masjidDocSnap.data();
                        currentMasjidDetails.id = masjidId;
                        
                        const area = currentMasjidDetails.area || 'N/A';
                        const city = currentMasjidDetails.city ? currentMasjidDetails.city.substring(0, 3).toUpperCase() : 'N/A';
                        const state = currentMasjidDetails.state ? currentMasjidDetails.state.substring(0, 3).toUpperCase() : 'N/A';
                        masjidLocationInfo.textContent = `${area}, ${city}, ${state}`;
                        viewDetailsBtn.classList.remove('hidden');
                        directionsBtn.classList.remove('hidden');
                        
                        if (currentMasjidDetails.latitude && currentMasjidDetails.longitude) {
                            locationForAPI = { latitude: currentMasjidDetails.latitude, longitude: currentMasjidDetails.longitude };
                        } else {
                            console.warn('Masjid coordinates missing, falling back to user location for AlAdhan API.');
                        }
                        
                        fetchedAlAdhanTimes = await fetchPrayerTimesFromAlAdhan(
                            locationForAPI.latitude, 
                            locationForAPI.longitude, 
                            1,
                            parseInt(asrCalculationSchool)
                        );

                        const prayerTimesDocRef = doc(db, 'prayerTimes', masjidId);
                        const prayerTimesDocSnap = await getDoc(prayerTimesDocRef);

                        if (prayerTimesDocSnap.exists()) {
                            const data = prayerTimesDocSnap.data();
                            prayerDetails = [
                                { name: 'Fajr', azanTime: data.FajrAzan, prayerTime: data.FajrPrayer, endTime: (fetchedAlAdhanTimes ? fetchedAlAdhanTimes.Fajr.endTime : data.FajrEndTime || defaultPrayerTimes.Fajr.endTime), rakats: rakatFunctions.Fajr() },
                                { name: 'Dhuhr', azanTime: data.DhuhrAzan, prayerTime: data.DhuhrPrayer, endTime: (fetchedAlAdhanTimes ? fetchedAlAdhanTimes.Dhuhr.endTime : data.DhuhrEndTime || defaultPrayerTimes.Dhuhr.endTime), rakats: rakatFunctions.Dhuhr() },
                                { name: 'Asr', azanTime: data.AsrAzan, prayerTime: data.AsrPrayer, endTime: (fetchedAlAdhanTimes ? fetchedAlAdhanTimes.Asr.endTime : data.AsrEndTime || defaultPrayerTimes.Asr.endTime), rakats: rakatFunctions.Asr() },
                                { name: 'Maghrib', azanTime: data.MaghribAzan, prayerTime: data.MaghribPrayer, endTime: (fetchedAlAdhanTimes ? fetchedAlAdhanTimes.Maghrib.endTime : data.MaghribEndTime || defaultPrayerTimes.Maghrib.endTime), rakats: rakatFunctions.Maghrib() },
                                { name: 'Isha', azanTime: data.IshaAzan, prayerTime: data.IshaPrayer, endTime: (fetchedAlAdhanTimes ? fetchedAlAdhanTimes.Isha.endTime : data.IshaEndTime || defaultPrayerTimes.Isha.endTime), rakats: rakatFunctions.Isha() },
                                { name: 'Jumuah', azanTime: data.JumuahAzan, prayerTime: data.JumuahPrayer, endTime: data.JumuahEndTime || defaultPrayerTimes.Jumuah.endTime, rakats: rakatFunctions.Jumuah() }
                            ];
                            currentSehriTime = (fetchedAlAdhanTimes ? fetchedAlAdhanTimes.Sehri : data.SehriTime || defaultPrayerTimes.Fajr.azanTime);
                            currentIftariTime = (fetchedAlAdhanTimes ? fetchedAlAdhanTimes.Iftari : data.IftariTime || defaultPrayerTimes.Maghrib.azanTime);
                        } else {
                            console.warn(`Prayer times for masjid ID ${masjidId} not found in Firestore. Using AlAdhan API for all times.`);
                            if (fetchedAlAdhanTimes) {
                                prayerDetails = [
                                    { name: 'Fajr', azanTime: fetchedAlAdhanTimes.Fajr.azanTime, prayerTime: fetchedAlAdhanTimes.Fajr.prayerTime, endTime: fetchedAlAdhanTimes.Fajr.endTime, rakats: rakatFunctions.Fajr() },
                                    { name: 'Dhuhr', azanTime: fetchedAlAdhanTimes.Dhuhr.azanTime, prayerTime: fetchedAlAdhanTimes.Dhuhr.prayerTime, endTime: fetchedAlAdhanTimes.Dhuhr.endTime, rakats: rakatFunctions.Dhuhr() },
                                    { name: 'Asr', azanTime: fetchedAlAdhanTimes.Asr.azanTime, prayerTime: fetchedAlAdhanTimes.Asr.prayerTime, endTime: fetchedAlAdhanTimes.Asr.endTime, rakats: rakatFunctions.Asr() },
                                    { name: 'Maghrib', azanTime: fetchedAlAdhanTimes.Maghrib.azanTime, prayerTime: fetchedAlAdhanTimes.Maghrib.prayerTime, endTime: fetchedAlAdhanTimes.Maghrib.endTime, rakats: rakatFunctions.Maghrib() },
                                    { name: 'Isha', azanTime: fetchedAlAdhanTimes.Isha.azanTime, prayerTime: fetchedAlAdhanTimes.Isha.prayerTime, endTime: fetchedAlAdhanTimes.Isha.endTime, rakats: rakatFunctions.Isha() },
                                    { name: 'Jumuah', azanTime: defaultPrayerTimes.Jumuah.azanTime, prayerTime: defaultPrayerTimes.Jumuah.prayerTime, endTime: defaultPrayerTimes.Jumuah.endTime, rakats: rakatFunctions.Jumuah() }
                                ];
                                currentSehriTime = fetchedAlAdhanTimes.Sehri;
                                currentIftariTime = fetchedAlAdhanTimes.Iftari;
                            } else {
                                prayerDetails = Object.values(defaultPrayerTimes).map(p => ({
                                    name: p.name, azanTime: p.azanTime, prayerTime: p.prayerTime, endTime: p.endTime, rakats: rakatFunctions[p.name]()
                                }));
                                currentSehriTime = defaultPrayerTimes.Fajr.azanTime;
                                currentIftariTime = defaultPrayerTimes.Maghrib.azanTime;
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching masjid or prayer times for ${masjidId}:`, error);
                    showCustomMessage(`Failed to load masjid data. Attempting AlAdhan API.`, 'error');
                    fetchedAlAdhanTimes = await fetchPrayerTimesFromAlAdhan(userLocation.latitude, userLocation.longitude, 1, parseInt(asrCalculationSchool));
                    if (fetchedAlAdhanTimes) {
                        prayerDetails = [
                            { name: 'Fajr', azanTime: fetchedAlAdhanTimes.Fajr.azanTime, prayerTime: fetchedAlAdhanTimes.Fajr.prayerTime, endTime: fetchedAlAdhanTimes.Fajr.endTime, rakats: rakatFunctions.Fajr() },
                            { name: 'Dhuhr', azanTime: fetchedAlAdhanTimes.Dhuhr.azanTime, prayerTime: fetchedAlAdhanTimes.Dhuhr.prayerTime, endTime: fetchedAlAdhanTimes.Dhuhr.endTime, rakats: rakatFunctions.Dhuhr() },
                            { name: 'Asr', azanTime: fetchedAlAdhanTimes.Asr.azanTime, prayerTime: fetchedAlAdhanTimes.Asr.prayerTime, endTime: fetchedAlAdhanTimes.Asr.endTime, rakats: rakatFunctions.Asr() },
                            { name: 'Maghrib', azanTime: fetchedAlAdhanTimes.Maghrib.azanTime, prayerTime: fetchedAlAdhanTimes.Maghrib.prayerTime, endTime: fetchedAlAdhanTimes.Maghrib.endTime, rakats: rakatFunctions.Maghrib() },
                            { name: 'Isha', azanTime: fetchedAlAdhanTimes.Isha.azanTime, prayerTime: fetchedAlAdhanTimes.Isha.prayerTime, endTime: fetchedAlAdhanTimes.Isha.endTime, rakats: rakatFunctions.Isha() },
                            { name: 'Jumuah', azanTime: defaultPrayerTimes.Jumuah.azanTime, prayerTime: defaultPrayerTimes.Jumuah.prayerTime, endTime: defaultPrayerTimes.Jumuah.endTime, rakats: rakatFunctions.Jumuah() }
                        ];
                        currentSehriTime = fetchedAlAdhanTimes.Sehri;
                        currentIftariTime = fetchedAlAdhanTimes.Iftari;
                    } else {
                        prayerDetails = Object.values(defaultPrayerTimes).map(p => ({
                            name: p.name, azanTime: p.azanTime, prayerTime: p.prayerTime, endTime: p.endTime, rakats: rakatFunctions[p.name]()
                        }));
                        currentSehriTime = defaultPrayerTimes.Fajr.azanTime;
                        currentIftariTime = defaultPrayerTimes.Maghrib.azanTime;
                    }
                }
            } else {
                showCustomMessage('No masjid selected. Fetching prayer times based on your location.', 'info');
                fetchedAlAdhanTimes = await fetchPrayerTimesFromAlAdhan(userLocation.latitude, userLocation.longitude, 1, parseInt(asrCalculationSchool));
                if (fetchedAlAdhanTimes) {
                    prayerDetails = [
                        { name: 'Fajr', azanTime: fetchedAlAdhanTimes.Fajr.azanTime, prayerTime: fetchedAlAdhanTimes.Fajr.prayerTime, endTime: fetchedAlAdhanTimes.Fajr.endTime, rakats: rakatFunctions.Fajr() },
                        { name: 'Dhuhr', azanTime: fetchedAlAdhanTimes.Dhuhr.azanTime, prayerTime: fetchedAlAdhanTimes.Dhuhr.prayerTime, endTime: fetchedAlAdhanTimes.Dhuhr.endTime, rakats: rakatFunctions.Dhuhr() },
                        { name: 'Asr', azanTime: fetchedAlAdhanTimes.Asr.azanTime, prayerTime: fetchedAlAdhanTimes.Asr.prayerTime, endTime: fetchedAlAdhanTimes.Asr.endTime, rakats: rakatFunctions.Asr() },
                        { name: 'Maghrib', azanTime: fetchedAlAdhanTimes.Maghrib.azanTime, prayerTime: fetchedAlAdhanTimes.Maghrib.prayerTime, endTime: fetchedAlAdhanTimes.Maghrib.endTime, rakats: rakatFunctions.Maghrib() },
                        { name: 'Isha', azanTime: fetchedAlAdhanTimes.Isha.azanTime, prayerTime: fetchedAlAdhanTimes.Isha.prayerTime, endTime: fetchedAlAdhanTimes.Isha.endTime, rakats: rakatFunctions.Isha() },
                        { name: 'Jumuah', azanTime: defaultPrayerTimes.Jumuah.azanTime, prayerTime: defaultPrayerTimes.Jumuah.prayerTime, endTime: defaultPrayerTimes.Jumuah.endTime, rakats: rakatFunctions.Jumuah() }
                    ];
                    currentSehriTime = fetchedAlAdhanTimes.Sehri;
                    currentIftariTime = fetchedAlAdhanTimes.Iftari;
                } else {
                    prayerDetails = Object.values(defaultPrayerTimes).map(p => ({
                        name: p.name, azanTime: p.azanTime, prayerTime: p.prayerTime, endTime: p.endTime, rakats: rakatFunctions[p.name]()
                    }));
                    currentSehriTime = defaultPrayerTimes.Fajr.azanTime;
                    currentIftariTime = defaultPrayerTimes.Maghrib.azanTime;
                }
                masjidLocationInfo.textContent = '';
            }
            
            currentUserPrayerTimes = prayerDetails.map(p => ({ name: p.name, time: p.prayerTime }));

            prayerDetails.forEach(prayer => {
                const prayerCard = document.createElement('div');
                prayerCard.className = 'prayer-card';
                const formattedAzanTime = prayer.azanTime ? formatTimeToAMPM(prayer.azanTime) : 'N/A';
                const formattedPrayerTime = prayer.prayerTime ? formatTimeToAMPM(prayer.prayerTime) : 'N/A';
                const formattedEndTime = prayer.endTime ? formatTimeToAMPM(prayer.endTime) : 'N/A';

                prayerCard.innerHTML = `
                    <div class="flex items-center space-x-4 flex-grow">
                        <i class="fas fa-mosque text-green-700 text-2xl"></i>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${prayer.name}</h3>
                            <p class="text-sm text-gray-500">Azan: <span class="font-medium text-gray-700">${formattedAzanTime}</span></p>
                            <p class="text-sm text-gray-500">Prayer: <span class="font-bold text-green-700">${formattedPrayerTime}</span></p>
                            <p class="text-xs text-gray-400">Ends: ${formattedEndTime}</p>
                        </div>
                    </div>
                    <div class="rakat-container">
                        ${formatRakatDetails(prayer.rakats)}
                    </div>
                `;
                prayerTimesDiv.appendChild(prayerCard);
            });
            updateNextPrayer(currentUserPrayerTimes);
            sehriTimeDisplay.textContent = formatTimeToAMPM(currentSehriTime);
            iftariTimeDisplay.textContent = formatTimeToAMPM(currentIftariTime);
        }

        // Function to update current time, day and date
        function updateCurrentTime() {
            const now = new Date();
            const englishTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            const englishDay = now.toLocaleDateString('en-US', { weekday: 'long' });
            const englishDate = now.toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });

            currentEnglishTimeHeader.textContent = `${englishTime}`;
            currentEnglishDayDisplay.textContent = `${englishDay}`;
            currentEnglishDateDisplay.textContent = `${englishDate}`;
            currentTimeMain.textContent = `${englishTime}`;

            updateHijriDate(now);
            updateNextPrayer(currentUserPrayerTimes);
        }

        // Function to update Hijri date
        function updateHijriDate(date) {
            try {
                const hijriDate = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }).format(date);
                document.getElementById('hijri-date').textContent = `${hijriDate}`;
            } catch (e) {
                console.error('Could not format Hijri date:', e);
                document.getElementById('hijri-date').textContent = '';
            }
        }

        // Function to get and display user's current area, city, country
        async function getUserCurrentArea() {
            if (userCurrentLocationDisplay.textContent === "Getting location...") {
                return;
            }
            userCurrentLocationDisplay.textContent = "Getting location...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    userLocation.latitude = position.coords.latitude;
                    userLocation.longitude = position.coords.longitude;
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.latitude}&lon=${userLocation.longitude}&zoom=10&addressdetails=1`);
                        const data = await response.json();
                        let areaText = "";
                        if (data.address) {
                            const address = data.address;
                            userLocation.city = address.city || address.town || address.village || address.county || '';
                            userLocation.country = address.country || '';

                            if (address.suburb) areaText += address.suburb;
                            else if (address.city_district) areaText += data.address.city_district;
                            else if (userLocation.city) areaText += userLocation.city;
                            else areaText += data.display_name.split(',')[0];
                        } else {
                            areaText += "Unknown Area";
                        }
                        userCurrentLocationDisplay.textContent = areaText;
                        const selectedMasjidId = document.getElementById('masjid-select').value;
                        if (!selectedMasjidId) {
                            displayPrayerTimes('');
                        }
                    } catch (error) {
                        console.error('Error in reverse geocoding:', error);
                        userCurrentLocationDisplay.textContent = "Unable to determine area.";
                    }
                }, (error) => {
                    console.error('Error getting user location:', error);
                    userCurrentLocationDisplay.textContent = "Geolocation denied or unavailable.";
                });
            } else {
                userCurrentLocationDisplay.textContent = "Geolocation not supported by browser.";
            }
        }
        
        // Function to update next prayer time and duration left
function updateNextPrayer(prayerDetailsArray) {
    const now = new Date();
    const dayOfWeek = now.getDay(); // 0 for Sunday, 5 for Friday, 6 for Saturday
    
    let nextPrayerName = 'None';
    let nextPrayerTimeStr = '--:-- --';
    let durationLeftStr = '--:--';
    let nextPrayerDateTime = null;
    
    const prayerCards = document.querySelectorAll('.prayer-card');
    prayerCards.forEach(card => card.classList.remove('current-prayer-card'));
    
    let futurePrayersToday = [];
    for (const prayer of prayerDetailsArray) {
        const prayerName = prayer.name;
        // On Friday, check for both Jumuah and other prayers
        if (dayOfWeek === 5) {
            // Check all prayers on Friday, including Jumuah
            const prayerTimeStr = (prayerName === 'Jumuah') ? prayer.time : prayer.time || '00:00';
            const [hours, minutes] = prayerTimeStr.split(':').map(Number);
            const prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
            if (prayerDate > now) {
                futurePrayersToday.push({ name: prayerName, time: prayerDate });
            }
        } else {
            // On other days, skip Jumuah
            if (prayerName === 'Jumuah') continue;
            const prayerTimeStr = prayer.time || '00:00';
            const [hours, minutes] = prayerTimeStr.split(':').map(Number);
            const prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
            if (prayerDate > now) {
                futurePrayersToday.push({ name: prayerName, time: prayerDate });
            }
        }
    }

    futurePrayersToday.sort((a, b) => a.time.getTime() - b.time.getTime());

    if (futurePrayersToday.length > 0) {
        nextPrayerName = futurePrayersToday[0].name;
        nextPrayerTimeStr = futurePrayersToday[0].time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        nextPrayerDateTime = futurePrayersToday[0].time;
    } else if (prayerDetailsArray.length > 0) {
        const fajrTime = prayerDetailsArray.find(p => p.name === 'Fajr')?.time || '00:00';
        const [fajrHours, fajrMinutes] = fajrTime.split(':').map(Number);
        const fajrTomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, fajrHours, fajrMinutes, 0);
        nextPrayerName = 'Fajr';
        nextPrayerTimeStr = fajrTomorrow.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        nextPrayerDateTime = fajrTomorrow;
    }

    prayerCards.forEach(card => {
        const prayerNameInCard = card.querySelector('h3').textContent.trim();
        if (prayerNameInCard === nextPrayerName) {
            card.classList.add('current-prayer-card');
        }
    });

    if (nextPrayerDateTime) {
        const diffMs = nextPrayerDateTime - now;
        const diffSeconds = Math.floor(diffMs / 1000);
        const minutes = Math.floor(diffSeconds / 60);
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        durationLeftStr = `${hours}h ${remainingMinutes}m`;
    }

    document.getElementById('next-prayer-name').textContent = nextPrayerName;
    document.getElementById('next-prayer-time').textContent = nextPrayerTimeStr;
    document.getElementById('duration-left').textContent = durationLeftStr;
}

        // Functions for user actions
        async function displayUserProfile(user) {
            if (!user) {
                showCustomMessage('You must be logged in to view your profile.', 'error');
                return;
            }
            showCustomMessage('Fetching your profile...', 'info');
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                let profileHtml = '';
                if (userDocSnap.exists()) {
                    userProfileData = userDocSnap.data();
                    profileHtml = `
                        <form id="profile-edit-form">
                            <p class="mb-2"><strong>Email:</strong> ${userProfileData.email || 'N/A'}</p>
                            <label for="firstName" class="block text-sm font-medium text-gray-700">First Name</label>
                            <input type="text" id="firstName" name="firstName" value="${userProfileData.firstName || ''}" class="w-full p-2 border border-gray-300 rounded mb-2">
                            <label for="lastName" class="block text-sm font-medium text-gray-700">Last Name</label>
                            <input type="text" id="lastName" name="lastName" value="${userProfileData.lastName || ''}" class="w-full p-2 border border-gray-300 rounded mb-2">
                            <label for="masjidId" class="block text-sm font-medium text-gray-700">Masjid ID</label>
                            <input type="text" id="masjidId" name="masjidId" value="${userProfileData.masjidId || ''}" class="w-full p-2 border border-gray-300 rounded mb-2">
                            <label for="role" class="block text-sm font-medium text-gray-700">Role</label>
                            <input type="text" id="role" name="role" value="${userProfileData.role || ''}" class="w-full p-2 border border-gray-300 rounded mb-4" disabled>
                            <button type="submit" class="mt-4 bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Update Profile</button>
                        </form>
                    `;
                } else {
                    profileHtml = `
                        <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                        <p class="mt-2 text-red-500">No additional profile data found in Firestore.</p>
                    `;
                }
                profileDetailsModalBody.innerHTML = profileHtml;
                profileDetailsModalOverlay.classList.add('show');
                if (document.getElementById('profile-edit-form')) {
                    document.getElementById('profile-edit-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const updatedData = {
                            firstName: document.getElementById('firstName').value,
                            lastName: document.getElementById('lastName').value,
                            masjidId: document.getElementById('masjidId').value
                        };
                        try {
                            const userDocRef = doc(db, 'users', user.uid);
                            await updateDoc(userDocRef, updatedData);
                            showCustomMessage('Profile updated successfully!', 'success');
                            profileDetailsModalOverlay.classList.remove('show');
                            onAuthStateChanged(auth, (u) => { if(u) updateUserName(u); });
                        } catch (error) {
                            console.error('Error updating profile:', error);
                            showCustomMessage('Failed to update profile.', 'error');
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
                showCustomMessage('Failed to fetch user profile.', 'error');
            }
        }

        function displayChangePassword() {
            changePasswordModalOverlay.classList.add('show');
        }

        async function updatePasswordAction() {
            const user = auth.currentUser;
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            if (newPassword.length < 6) {
                showCustomMessage('Password should be at least 6 characters.', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showCustomMessage('Passwords do not match.', 'error');
                return;
            }
            try {
                await updatePassword(user, newPassword);
                showCustomMessage('Password updated successfully!', 'success');
                changePasswordModalOverlay.classList.remove('show');
            } catch (error) {
                console.error('Error updating password:', error);
                showCustomMessage(`Failed to update password: ${error.message}`, 'error');
            }
        }
        
        async function displayQiblaDirection() {
            qiblaDirectionModalOverlay.classList.add('show');
            qiblaStatus.textContent = 'Getting your location...';
            qiblaIndicatorContainer.innerHTML = '';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const meccaLat = 21.4225;
                    const meccaLon = 39.8262;
                    const latRad = toRadians(lat);
                    const lonRad = toRadians(lon);
                    const meccaLatRad = toRadians(meccaLat);
                    const meccaLonRad = toRadians(meccaLon);
                    const deltaLon = meccaLonRad - lonRad;
                    const qiblaAngle = toDegrees(
                        Math.atan2(
                            Math.sin(deltaLon),
                            (Math.cos(latRad) * Math.tan(meccaLatRad)) - (Math.sin(latRad) * Math.cos(deltaLon))
                        )
                    );
                    const normalizedQiblaAngle = (qiblaAngle + 360) % 360;
                    qiblaStatus.innerHTML = `Qibla direction is <span class="font-bold text-green-700">${normalizedQiblaAngle.toFixed(2)}°</span> from North.`;
                    
                    qiblaIndicatorContainer.innerHTML = `
                        <div class="relative w-24 h-24 mx-auto">
                            <div class="absolute w-full h-full border-4 border-green-500 rounded-full flex items-center justify-center">
                                <span class="absolute top-0 text-xs text-green-700 font-bold">N</span>
                            </div>
                            <div class="absolute w-full h-full transform transition-transform duration-500" style="transform: rotate(${normalizedQiblaAngle}deg);">
                                <div class="w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-b-[24px] border-b-green-700 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-full"></div>
                            </div>
                        </div>
                    `;
                }, (error) => {
                    console.error('Error getting location for Qibla:', error);
                    qiblaStatus.textContent = 'Unable to get location for Qibla direction.';
                });
            } else {
                qiblaStatus.textContent = 'Geolocation not supported by this browser.';
            }
        }
        
        function toRadians(degrees) {
            return degrees * Math.PI / 180;
        }

        function toDegrees(radians) {
            return radians * 180 / Math.PI;
        }
        
        function handleLogout() {
            signOut(auth).then(() => {
                showCustomMessage('Logged out successfully.', 'success');
                profileDetailsModalOverlay.classList.remove('show');
                changePasswordModalOverlay.classList.remove('show');
                qiblaDirectionModalOverlay.classList.remove('show');
                settingsModalOverlay.classList.remove('show');
                sessionStorage.removeItem('userFirstName'); // Clear user data from sessionStorage
                sessionStorage.removeItem('userLastName'); // Clear user data from sessionStorage
            }).catch((error) => {
                console.error('Logout error:', error);
                showCustomMessage('Logout failed. Please try again.', 'error');
            });
        }
        
        function updateUserName(user) {
            const userDocRef = doc(db, 'users', user.uid);
            getDoc(userDocRef).then(userDocSnap => {
                let userName = 'User Profile';
                let firstName = '';
                let lastName = '';
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    if (userData.firstName && userData.lastName) {
                        userName = `${userData.firstName} ${userData.lastName}`;
                        firstName = userData.firstName;
                        lastName = userData.lastName;
                    } else if (userData.name) {
                        userName = userData.name;
                        // Attempt to parse name if it's a single string like "John Doe"
                        const nameParts = userData.name.split(' ');
                        firstName = nameParts[0] || '';
                        lastName = nameParts.slice(1).join(' ') || '';
                    }
                }
                const nameDisplay = document.getElementById('user-name-display');
                if (nameDisplay) {
                    nameDisplay.textContent = userName;
                }
                // Store first and last name in sessionStorage
                sessionStorage.setItem('userFirstName', firstName);
                sessionStorage.setItem('userLastName', lastName);
            }).catch(error => {
                console.error('Error fetching user name for header:', error);
            });
        }
        
        function handleDropdownToggle() {
            const dropdownContent = document.getElementById('user-dropdown-content');
            dropdownContent.classList.toggle('show');
        }
        
        function closeDropdown() {
            const dropdownContent = document.getElementById('user-dropdown-content');
            if (dropdownContent) {
                dropdownContent.classList.remove('show');
            }
        }

        async function displaySettings() {
            settingsModalOverlay.classList.add('show');
            const user = auth.currentUser;
            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    asrCalculationSchool = userData.asrCalculationSchool || '1'; 
                }
            }
            if (asrCalculationSchool === '1') {
                asrHanafiRadio.checked = true;
            } else {
                asrShafiRadio.checked = true;
            }
        }

        async function saveSettings() {
            const user = auth.currentUser;
            if (!user) {
                showCustomMessage('You must be logged in to save settings.', 'error');
                return;
            }
            const selectedSchool = asrHanafiRadio.checked ? '1' : '0';
            asrCalculationSchool = selectedSchool;
            try {
                const userDocRef = doc(db, 'users', user.uid);
                await updateDoc(userDocRef, { asrCalculationSchool: selectedSchool });
                showCustomMessage('Settings saved successfully!', 'success');
                settingsModalOverlay.classList.remove('show');
                const selectedMasjidId = document.getElementById('masjid-select').value;
                if (!selectedMasjidId) {
                    displayPrayerTimes('');
                } else {
                    displayPrayerTimes(selectedMasjidId);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showCustomMessage('Failed to save settings.', 'error');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await populateMasjidDropdown();
            getUserCurrentArea();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            const masjidSelect = document.getElementById('masjid-select');
            masjidSelect.addEventListener('change', (event) => {
                const selectedMasjidId = event.target.value;
                displayPrayerTimes(selectedMasjidId);
            });
            
            locationBtn.addEventListener('click', getUserCurrentArea);
            // Quran button listener is now inside onAuthStateChanged
            
            viewDetailsBtn.addEventListener('click', () => {
                if (currentMasjidDetails) {
                    const detailsHtml = `
                        <p><strong>Name:</strong> ${currentMasjidDetails.name || 'N/A'}</p>
                        <p><strong>Address:</strong> ${currentMasjidDetails.address || 'N/A'}</p>
                        <p><strong>Area:</strong> ${currentMasjidDetails.area || 'N/A'}</p>
                        <p><strong>City:</strong> ${currentMasjidDetails.city || 'N/A'}</p>
                        <p><strong>State:</strong> ${currentMasjidDetails.state || 'N/A'}</p>
                        <p><strong>Contact:</strong> ${currentMasjidDetails.contact || 'N/A'}</p>
                    `;
                    masjidDetailsModalBody.innerHTML = detailsHtml;
                    masjidDetailsModalOverlay.classList.add('show');
                } else {
                    showCustomMessage('Please select a masjid first.', 'info');
                }
            });

            directionsBtn.addEventListener('click', () => {
                if (currentMasjidDetails && currentMasjidDetails.latitude && currentMasjidDetails.longitude) {
                    const mapsUrl = `http://google.com/maps/place/${currentMasjidDetails.latitude},${currentMasjidDetails.longitude}`;
                    window.open(mapsUrl, '_blank');
                } else {
                    showCustomMessage('Directions not available for this masjid.', 'error');
                }
            });

            modalCloseBtn.addEventListener('click', () => {
                masjidDetailsModalOverlay.classList.remove('show');
            });
            profileModalCloseBtn.addEventListener('click', () => {
                profileDetailsModalOverlay.classList.remove('show');
            });
            changePasswordModalCloseBtn.addEventListener('click', () => {
                changePasswordModalOverlay.classList.remove('show');
            });
            qiblaDirectionModalCloseBtn.addEventListener('click', () => {
                qiblaDirectionModalOverlay.classList.remove('show');
            });
            settingsModalCloseBtn.addEventListener('click', () => {
                settingsModalOverlay.classList.remove('show');
            });

            updatePasswordBtn.addEventListener('click', updatePasswordAction);
            saveSettingsBtn.addEventListener('click', saveSettings);

            window.addEventListener('click', (event) => {
                if (event.target === masjidDetailsModalOverlay) masjidDetailsModalOverlay.classList.remove('show');
                if (event.target === profileDetailsModalOverlay) profileDetailsModalOverlay.classList.remove('show');
                if (event.target === changePasswordModalOverlay) changePasswordModalOverlay.classList.remove('show');
                if (event.target === qiblaDirectionModalOverlay) qiblaDirectionModalOverlay.classList.remove('show');
                if (event.target === settingsModalOverlay) settingsModalOverlay.classList.remove('show');
                
                const dropdown = document.querySelector('.dropdown');
                if (dropdown && !dropdown.contains(event.target)) {
                    closeDropdown();
                }
            });

            displayPrayerTimes(masjidSelect.value);
        });
        
        function handleLogin() {
            window.location.href = 'login.html';
        }

        onAuthStateChanged(auth, async (user) => {
            userAuthSection.innerHTML = '';
            const quranBtn = document.createElement('button');
            quranBtn.id = 'quran-btn';
            quranBtn.className = 'bg-white hover:bg-gray-200 text-green-700 font-bold py-2 px-4 rounded-full shadow-md transition-colors';
            quranBtn.innerHTML = '<i class="fas fa-book-open mr-2"></i>Quran';
            
            // This event listener now sets sessionStorage and then navigates
            quranBtn.addEventListener('click', () => {
                const firstName = sessionStorage.getItem('userFirstName') || '';
                const lastName = sessionStorage.getItem('userLastName') || '';
                // The data is already stored in sessionStorage by updateUserName
                window.location.href = 'Quran3.html';
            });
            userAuthSection.appendChild(quranBtn);

            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                let userName = 'User Profile';
                let firstName = '';
                let lastName = '';
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    currentUserRole = userData.role || 'user';
                    asrCalculationSchool = userData.asrCalculationSchool || '1';
                    if (userData.firstName && userData.lastName) {
                        userName = `${userData.firstName} ${userData.lastName}`;
                        firstName = userData.firstName;
                        lastName = userData.lastName;
                    } else if (userData.name) {
                        userName = userData.name;
                        const nameParts = userData.name.split(' ');
                        firstName = nameParts[0] || '';
                        lastName = nameParts.slice(1).join(' ') || '';
                    }
                } else {
                    currentUserRole = 'user';
                    asrCalculationSchool = '1';
                }

                // Store first and last name in sessionStorage immediately upon auth state change
                sessionStorage.setItem('userFirstName', firstName);
                sessionStorage.setItem('userLastName', lastName);


                const dropdownDiv = document.createElement('div');
                dropdownDiv.className = 'dropdown ml-4 relative';
                dropdownDiv.innerHTML = `
                    <button id="user-name-display" class="bg-white hover:bg-gray-200 text-green-700 font-bold py-2 px-4 rounded-full shadow-md transition-colors flex items-center">
                        <i class="fas fa-user-circle text-xl mr-2"></i>
                        <span class="hidden sm:inline-block">${userName}</span>
                    </button>
                    <div id="user-dropdown-content" class="dropdown-content absolute right-0 mt-2 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none">
                        <button id="show-profile-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Show Profile</button>
                        <button id="settings-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Settings</button>
                        <button id="change-password-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Change Password</button>
                        <button id="qibla-direction-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Qibla Direction</button>
                        <button id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Logout</button>
                    </div>
                `;
                userAuthSection.appendChild(dropdownDiv);
                
                document.getElementById('user-name-display').addEventListener('click', handleDropdownToggle);
                document.getElementById('show-profile-btn').addEventListener('click', () => { closeDropdown(); displayUserProfile(user); });
                document.getElementById('settings-btn').addEventListener('click', () => { closeDropdown(); displaySettings(); });
                document.getElementById('change-password-btn').addEventListener('click', () => { closeDropdown(); displayChangePassword(); });
                document.getElementById('qibla-direction-btn').addEventListener('click', () => { closeDropdown(); displayQiblaDirection(); });
                document.getElementById('logout-btn').addEventListener('click', () => { closeDropdown(); handleLogout(); });

            } else {
                currentUserRole = null;
                asrCalculationSchool = '1';
                const loginBtn = document.createElement('button');
                loginBtn.id = 'login-btn';
                loginBtn.className = 'bg-white hover:bg-gray-200 text-green-700 font-bold py-2 px-4 rounded-full shadow-md transition-colors ml-4';
                loginBtn.textContent = 'Login';
                loginBtn.addEventListener('click', handleLogin);
                userAuthSection.appendChild(loginBtn);
            }
        });
    </script>
</body>
</html>
